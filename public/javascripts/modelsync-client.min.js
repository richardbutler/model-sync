/*! modelsync - v0.0.1 - 2012-11-12
* Copyright (c) 2012 Richard Butler; Licensed  */
var ModelSync=function(e,t){var n=function(e){function t(e,t){if(e){if(typeof t=="function")return function(n){t.call(e,n)};if(t)return function(n){e[t]=n};if(typeof e=="function")return e}return null}function n(e,t){var n=e,r=[e],s;t=t.concat();while(n){s=t.shift();if(!(s&&t.length>0))break;n=i(n,s),r.push(n)}return r}function r(e){return e&&(e.__proto__===u||e.prototype===u)}function i(e,t){var n;return r(e)?n=e.get(t):n=e[t],typeof n=="function"?n():n}function s(e){var t,n;if(r(e)){n={};for(t in e.attributes)n[t]=s(e.get(t));return n}return e}function o(){a.warn&&console.log.apply(null,arguments)}var u=Object.create(e.prototype,{get:{enumerable:!1,value:function(e){return this.attributes||(this.attributes={}),this.attributes[e]}},set:{enumerable:!1,value:function(e,t){this.attributes||(this.attributes={}),this.attributes[e]=t,this.emit("change:"+e,t)}},toJSON:{enumerable:!1,value:function(){return s(this)}},hasOwnProperty:{enumerable:!1,value:function(e){return this.attributes&&this.attributes.hasOwnProperty(e)}}}),a={Bindable:u,isBindable:r,warn:!1,bind:function(e,n){var r,i,s="change:"+n,u;arguments.length>=3&&(r=arguments[2],arguments.length>=4&&(i=arguments[3])),u=t(r,i),u!==undefined&&(typeof e.on!="undefined"?e.on(s,u):o("WARN: One-time binding only for '"+n+"' as source is not a bindable object (EventEmitter)."),u(e[n]))},bindString:function(e,r){function v(){var t;a=n(e,d);if(l!==undefined){try{for(p=0;p<a.length;p++)c=a[p],h=d[p],typeof c.on!="undefined"&&c.on("change:"+h,m);t=i(c,h)}catch(s){o("WARN: Swallowed exception for",r+":",String(s)),t=null}l(t)}}function m(e){for(p=0;p<a.length;p++)c=a[p],h=d[p],c&&typeof c.removeListener!="undefined"&&c.removeListener("change:"+h,m);v()}var s,u,a,f,l,c,h,p,d=r.split(".");arguments.length>=3&&(s=arguments[2],arguments.length>=4&&(u=arguments[3])),l=t(s,u),v()},createObject:function(e){var t,n,r;t=Object.create(u);for(n in e)r=e[n],typeof r=="object"&&!(r instanceof Array)&&r.hasOwnProperty!==undefined&&(r=this.createObject(r)),t.set(n,r);return t}};return typeof window=="undefined"&&(module.exports=a),a}(typeof window=="undefined"?require("events").EventEmitter:t),r=function(){var e,t,n,r={setup:function(i){e=i.selector||".view",t=i.idAttribute||"id",n=i.attributePrefix||"data-",$(e).each(function(){r.setupView(this)})},setupView:function(e){function u(t){return typeof o=="function"?o(t,e):o}function a(e){var t=e.nodeName,r=String(e.textContent).trim(),f;if(r.charAt(0)==="{")r=r.substring(1,r.length-1).trim(),f=u(e),r.substr(0,5)==="this."?(console.log("bind",r.substr(5),"to",e,"within",f),s.Binding.bindString(f,r.substr(5),e,"textContent")):s.bind(r,e,"textContent");else if(t.indexOf(n)===0){if(!o){console.log("WARN: Could not bind "+t+" as there is no "+i+" view scope.");return}t=t.replace(n,""),r=new Function(r),f=u(e.ownerElement),$(e.ownerElement).bind(t,function(){r.apply(f)})}e.attributes&&Array.prototype.slice.apply(e.attributes).forEach(a)}var r=$(e),i,o;if(!r.length)return;i=r.attr(t),o=s.viewScopes[i],r.children().each(function(){a(this)})}};return r}(),i=function(e,t,n){function r(e,t){var n=e.split("/"),r,i;while(n.length){r=n.shift();if(r==="")continue;i=n.length===0,t.call(a,r,i)}}function i(e){var t=e,r=[],i;n.isBindable(e)&&(t=e.attributes);if(Object.hasOwnProperty("keys"))r=Object.keys(t);else for(i in t)r.push(i);return r}function s(e){var t=e,r,s,o;n.isBindable(e)&&(t=e.attributes);if(t){s=i(t);for(r=0;r<s.length;r++)o=s[r],delete t[o]}}function o(e,t){return n.isBindable(e)?e.get(t):e[t]}function u(e,t,r){n.isBindable(e)?e.set(t,r):e[t]=r}var a={deserialiser:null,init:function(e,t){t&&(this.deserialiser=t),e&&(this.store=this._deserialise(e)),console.log("MemoryStore.init",this.store)},store:n.createObject({test:{path1:{items:[1,2,3,4],foo:{thing:"wotsit",bar:!0}},path2:{items:[1,2],foo:{bar:!1,thing:"stuff"}}}}),save:function(e,t,n){var r=this.store;this._patch(r,e,this._deserialise(t));if(n)return n()},read:function(e,t){var n,r,i;if(typeof e=="string")n=this._readSync(i);else{n=this._deserialise({});while(e.length)i=e.shift(),r=this._readSync(i),this._patch(n,i,r)}t(n)},_patch:function(e,t,n){var a=e,f=this,l,c;if(t==="/"){s(a),c=i(n);for(l=0;l<c.length;l++)u(a,c[l],o(n,c[l]))}else r(t,function(e,t){t?u(a,e,n):a.hasOwnProperty(e)||u(a,e,this._deserialise({})),a=o(a,e)});return e},_deserialise:function(e){return typeof this.deserialiser=="function"&&(e=this.deserialiser(e)),e},_readSync:function(e){var t=this.store,n;return r(e,function(e,r){if(!t){n=null;return}t=o(t,e),r&&(n=t)}),n}};return e.extend(a,t.prototype),typeof window=="undefined"&&(module.exports=a),a}(typeof window=="undefined"?require("underscore"):e,typeof window=="undefined"?require("events").EventEmitter:t,typeof window=="undefined"?require("../util/binding"):n),s={Binding:n,MemoryStore:i,View:r,viewOptions:{selector:".view",idAttribute:"id",attributePrefix:"data-"},store:i,listen:function(t){var n=this;e.extend(this,t),this.socket.on("state",function(e){n.store.save("/",e)}),this.socket.on("save",function(e,t){n.store.save(e,t)}),this.View.setup(this.viewOptions)},bind:function(e,t,r){var i=Array.prototype.slice.call(arguments);i.unshift(this.store.store),n.bindString.apply(n,i)}};return s.store.init({},function(e){return n.createObject(e)}),s}(window._,window.EventEmitter);