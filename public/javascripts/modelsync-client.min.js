/*! modelsync - v0.0.1 - 2012-11-12
* Copyright (c) 2012 Richard Butler; Licensed  */
var ModelSync=function(e,t){var n=function(e){function t(e,t){if(e){if(typeof t=="function")return function(n){t.call(e,n)};if(t)return function(n){e[t]=n};if(typeof e=="function")return e}return null}function n(e,t){var n=e,r=[e],s;t=t.concat();while(n){s=t.shift();if(!(s&&t.length>0))break;n=i(n,s),r.push(n)}return r}function r(e){return e.__proto__===o||e.prototype===o}function i(e,t){return r(e)?e.get(t):e[t]}function s(e){var t,n;if(r(e)){n={};for(t in e.attributes)n[t]=s(e.get(t));return n}return e}var o=Object.create(e.prototype,{get:{enumerable:!1,value:function(e){return this.attributes||(this.attributes={}),this.attributes[e]}},set:{enumerable:!1,value:function(e,t){this.attributes||(this.attributes={}),this.attributes[e]=t,this.emit("change:"+e,t)}},toJSON:{enumerable:!1,value:function(){return s(this)}},hasOwnProperty:{enumerable:!1,value:function(e){return this.attributes&&this.attributes.hasOwnProperty(e)}}}),u={Bindable:o,isBindable:r,bind:function(e,n){var r,i,s="change:"+n,o;arguments.length>=3&&(r=arguments[2],arguments.length>=4&&(i=arguments[3])),o=t(r,i),o!==undefined&&(e.on(s,o),o(e[n]))},bindString:function(e,r){function d(){var t;u=n(e,p);if(f!==undefined){try{for(h=0;h<u.length;h++)l=u[h],c=p[h],l.on("change:"+c,v);t=i(l,c)}catch(r){t=null}f(t)}}function v(e){for(h=0;h<u.length;h++)l=u[h],c=p[h],l&&l.removeListener("change:"+c,v);d()}var s,o,u,a,f,l,c,h,p=r.split(".");arguments.length>=3&&(s=arguments[2],arguments.length>=4&&(o=arguments[3])),f=t(s,o),d()},createObject:function(e){var t,n,r;t=Object.create(o);for(n in e)r=e[n],typeof r=="object"&&!(r instanceof Array)&&r.hasOwnProperty!==undefined&&(r=this.createObject(r)),t.set(n,r);return t}};return typeof window=="undefined"&&(module.exports=u),u}(typeof window=="undefined"?require("events").EventEmitter:t),r=function(e,t,n){function r(e,t){var n=e.split("/"),r,i;while(n.length){r=n.shift();if(r==="")continue;i=n.length===0,t.call(a,r,i)}}function i(e){var t=e,r=[],i;n.isBindable(e)&&(t=e.attributes);if(Object.hasOwnProperty("keys"))r=Object.keys(t);else for(i in t)r.push(i);return r}function s(e){var t=e,r,s,o;n.isBindable(e)&&(t=e.attributes),s=i(t);for(r=0;r<s.length;r++)o=s[r],delete t[o]}function o(e,t){return n.isBindable(e)?e.get(t):e[t]}function u(e,t,r){n.isBindable(e)?e.set(t,r):e[t]=r}var a={deserialiser:null,init:function(e,t){t&&(this.deserialiser=t),e&&(this.store=this._deserialise(e)),console.log("MemoryStore.init",this.store)},store:n.createObject({test:{path1:{items:[1,2,3,4],foo:{thing:"wotsit",bar:!0}},path2:{items:[1,2],foo:{bar:!1,thing:"stuff"}}}}),save:function(e,t,n){var r=this.store;this._patch(r,e,this._deserialise(t));if(n)return n()},read:function(e,t){var n,r,i;if(typeof e=="string")n=this._readSync(i);else{n=this._deserialise({});while(e.length)i=e.shift(),r=this._readSync(i),this._patch(n,i,r)}t(n)},_patch:function(e,t,n){var a=e,f=this,l,c;if(t==="/"){s(a),c=i(n);for(l=0;l<c.length;l++)u(a,c[l],o(n,c[l]))}else r(t,function(e,t){t?u(a,e,n):a.hasOwnProperty(e)||u(a,e,this._deserialise({})),a=o(a,e)});return e},_deserialise:function(e){return typeof this.deserialiser=="function"&&(e=this.deserialiser(e)),e},_readSync:function(e){var t=this.store,n;return r(e,function(e,r){if(!t){n=null;return}t=o(t,e),r&&(n=t)}),n}};return e.extend(a,t.prototype),typeof window=="undefined"&&(module.exports=a),a}(typeof window=="undefined"?require("underscore"):e,typeof window=="undefined"?require("events").EventEmitter:t,typeof window=="undefined"?require("../util/binding"):n),i={Binding:n,MemoryStore:r,store:r,listen:function(e){var t=this;e.on("state",function(e){t.store.save("/",e)}),e.on("save",function(e,n){t.store.save(e,n)})},bind:function(e,t,r){var i=Array.prototype.slice.call(arguments);i.unshift(this.store.store),n.bindString.apply(n,i)}};return i.store.init({},function(e){return n.createObject(e)}),i}(window._,window.EventEmitter);