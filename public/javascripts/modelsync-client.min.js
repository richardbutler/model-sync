/*! modelsync - v0.0.1 - 2012-11-10
* Copyright (c) 2012 Richard Butler; Licensed  */
var ModelSync=function(){function a(a,b){if(a){if(typeof b=="function")return function(c){b.call(a,c)};if(b)return function(c){a[b]=c};if(typeof a=="function")return a}return null}function b(a,b){var c=a,e=[a],f;b=b.concat();while(c){f=b.shift();if(f&&b.length>0)c=d(c,f),e.push(c);else break}return e}function c(a){return a.__proto__===f||a.prototype===f}function d(a,b){return c(a)?a.get(b):a[b]}function e(a){var b,d;if(c(a)){d={};for(b in a.attributes)d[b]=e(a.get(b));return d}return a}function h(a,b){var c=a.split("/"),d,e;while(c.length){d=c.shift();if(d==="")continue;e=c.length===0,b.call(m,d,e)}}function i(a){var b=a,c=[],d;g.isBindable(a)&&(b=a.attributes);if(Object.hasOwnProperty("keys"))c=Object.keys(b);else for(d in b)c.push(d);return c}function j(a){var b=a,c,d,e;g.isBindable(a)&&(b=a.attributes),d=i(b);for(c=0;c<d.length;c++)e=d[c],delete b[e]}function k(a,b){return g.isBindable(a)?a.get(b):a[b]}function l(a,b,c){g.isBindable(a)?a.set(b,c):a[b]=c}typeof process!="undefined"&&(EventEmitter=require("events").EventEmitter);var f=Object.create(EventEmitter.prototype,{get:{enumerable:!1,value:function(a){return this.attributes||(this.attributes={}),this.attributes[a]}},set:{enumerable:!1,value:function(a,b){this.attributes||(this.attributes={}),this.attributes[a]=b,this.emit("change:"+a,b)}},toJSON:{enumerable:!1,value:function(){return e(this)}},hasOwnProperty:{enumerable:!1,value:function(a){return this.attributes&&this.attributes.hasOwnProperty(a)}}}),g={Bindable:f,isBindable:c,bind:function(b,c){var d,e,f="change:"+c,g;arguments.length>=3&&(d=arguments[2],arguments.length>=4&&(e=arguments[3])),g=a(d,e),g!==undefined&&(b.on(f,g),g(b[c]))},bindString:function(c,e){function o(){var a;h=b(c,n);if(j!==undefined){try{for(m=0;m<h.length;m++)k=h[m],l=n[m],k.on("change:"+l,p);a=d(k,l)}catch(e){a=null}j(a)}}function p(a){for(m=0;m<h.length;m++)k=h[m],l=n[m],k&&k.removeListener("change:"+l,p);o()}var f,g,h,i,j,k,l,m,n=e.split(".");arguments.length>=3&&(f=arguments[2],arguments.length>=4&&(g=arguments[3])),j=a(f,g),o()},createObject:function(a){var b,c,d;b=Object.create(f);for(c in a)d=a[c],typeof d=="object"&&!(d instanceof Array)&&d.hasOwnProperty!==undefined&&(d=this.createObject(d)),b.set(c,d);return b}};typeof window=="undefined"?module.exports=g:window.Binding=g,typeof process!="undefined"&&(g=require("../util/binding"),EventEmitter=require("events").EventEmitter,_=require("underscore"));var m={deserialiser:null,init:function(a,b){b&&(this.deserialiser=b),a&&(this.store=this._deserialise(a)),console.log("MemoryStore.init",this.store)},store:g.createObject({test:{path1:{items:[1,2,3,4],foo:{thing:"wotsit",bar:!0}},path2:{items:[1,2],foo:{bar:!1,thing:"stuff"}}}}),save:function(a,b,c){var d=this.store;this._patch(d,a,this._deserialise(b));if(c)return c()},read:function(a,b){var c,d,e;if(typeof a=="string")c=this._readSync(e);else{c=this._deserialise({});while(a.length)e=a.shift(),d=this._readSync(e),this._patch(c,e,d)}b(c)},_patch:function(a,b,c){var d=a,e=this,f,g;if(b==="/"){j(d),g=i(c);for(f=0;f<g.length;f++)l(d,g[f],k(c,g[f]))}else h(b,function(a,b){b?l(d,a,c):d.hasOwnProperty(a)||l(d,a,this._deserialise({})),d=k(d,a)});return a},_deserialise:function(a){return typeof this.deserialiser=="function"&&(a=this.deserialiser(a)),a},_readSync:function(a){var b=this.store,c;return h(a,function(a,d){if(!b){c=null;return}b=k(b,a),d&&(c=b)}),c}};_.extend(m,EventEmitter.prototype),typeof window=="undefined"?module.exports=m:window.MemoryStore=m;var n={Binding:g,MemoryStore:m,store:m,listen:function(a){var b=this;a.on("state",function(a){b.store.save("/",a)}),a.on("save",function(a,c){b.store.save(a,c)})},bind:function(a,b,c){var d=Array.prototype.slice.call(arguments);d.unshift(this.store.store),g.bindString.apply(g,d)}};return n.store.init({},function(a){return g.createObject(a)}),n}();